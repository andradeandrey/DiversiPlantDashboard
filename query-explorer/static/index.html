<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiversiPlant Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(180deg, #000000 0%, #1a1a1a 50%, #262626 100%);
        }
        .card-gradient {
            background: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
        }
        .stat-gradient {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
        }
        .glow {
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.15);
        }
        .table-row:hover {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.4);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.6);
        }
        .query-input {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-gray-100">
    <!-- Header -->
    <header class="border-b border-white/10 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-cyan-500 flex items-center justify-center shadow-lg">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">
                            DiversiPlant
                        </h1>
                        <p class="text-sm text-gray-400">Database Admin & Query Explorer</p>
                    </div>
                </div>
                <div id="health-status" class="flex items-center gap-3 px-4 py-2 rounded-full bg-white/5 border border-white/10">
                    <div class="w-2.5 h-2.5 rounded-full bg-gray-500 animate-pulse" id="health-dot"></div>
                    <span class="text-sm text-gray-400" id="health-text">Checking...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-10 space-y-10">
        <!-- Stats Cards -->
        <section class="animate-fade-in">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Database Statistics
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5" id="stats-grid">
                <!-- Stats will be injected here -->
            </div>
        </section>

        <!-- Source Breakdown -->
        <section class="animate-slide-up" style="animation-delay: 0.1s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                </svg>
                Distribution by Source
            </h2>

            <!-- Growth Form Sources -->
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow mb-6">
                <h3 class="text-md font-semibold text-emerald-400 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                    Growth Form
                </h3>
                <div id="sources-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <!-- Growth form sources will be injected here -->
                </div>
            </div>

            <!-- Threat Status Sources -->
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow mb-6">
                <h3 class="text-md font-semibold text-rose-400 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-rose-500"></span>
                    Threat Status (IUCN)
                </h3>
                <div id="threat-sources-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Threat status sources will be injected here -->
                </div>
            </div>

            <!-- Lifespan Sources -->
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <h3 class="text-md font-semibold text-purple-400 mb-4 flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                    Lifespan
                </h3>
                <div id="lifespan-sources-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Lifespan sources will be injected here -->
                </div>
            </div>
        </section>

        <!-- Climate Data -->
        <section class="animate-slide-up" style="animation-delay: 0.15s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                </svg>
                Climate Data (WorldClim)
            </h2>
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <!-- Climate Query -->
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">TDWG Code</label>
                        <input type="text" id="climate-tdwg-input" placeholder="BZN, BZS, BZE..."
                               class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-sky-500/50 focus:ring-2 focus:ring-sky-500/20 transition-all duration-300">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Or Latitude</label>
                        <input type="number" step="0.0001" id="climate-lat-input" placeholder="-15.7"
                               class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-sky-500/50 focus:ring-2 focus:ring-sky-500/20 transition-all duration-300">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Longitude</label>
                        <input type="number" step="0.0001" id="climate-lon-input" placeholder="-47.9"
                               class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-sky-500/50 focus:ring-2 focus:ring-sky-500/20 transition-all duration-300">
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="queryClimate()"
                                class="flex-1 px-6 py-4 bg-gradient-to-r from-sky-600 to-cyan-600 hover:from-sky-500 hover:to-cyan-500 text-white font-semibold rounded-xl shadow-lg shadow-sky-500/20 hover:shadow-sky-500/40 transition-all duration-300 transform hover:scale-[1.02]">
                            TDWG
                        </button>
                        <button onclick="queryClimatePoint()"
                                class="flex-1 px-6 py-4 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 text-white font-semibold rounded-xl shadow-lg shadow-violet-500/20 hover:shadow-violet-500/40 transition-all duration-300 transform hover:scale-[1.02]"
                                title="Requer dados raster carregados">
                            Precise Raster
                        </button>
                    </div>
                </div>

                <!-- Info about query modes -->
                <div class="mb-6 p-4 bg-white/5 rounded-xl border border-white/10">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-sky-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm">
                            <p class="text-gray-300 mb-1"><strong class="text-sky-400">TDWG:</strong> Uses aggregated data by region (5 macro-regions in Brazil). Fast, always available.</p>
                            <p class="text-gray-300"><strong class="text-violet-400">Precise Raster:</strong> Uses high-resolution WorldClim data (~1km¬≤). Requires loading rasters with: <code class="bg-black/30 px-2 py-0.5 rounded text-xs">python crawlers/worldclim_raster.py --apply-migration</code></p>
                        </div>
                    </div>
                </div>

                <!-- Quick TDWG buttons -->
                <div class="mb-8">
                    <p class="text-sm text-gray-400 mb-3">Brazilian regions:</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setClimateTDWG('BZN')" class="px-4 py-2 bg-sky-500/10 hover:bg-sky-500/20 border border-sky-500/30 rounded-lg text-sm text-sky-300 hover:text-sky-200 transition-all duration-200">BZN - North</button>
                        <button onclick="setClimateTDWG('BZS')" class="px-4 py-2 bg-sky-500/10 hover:bg-sky-500/20 border border-sky-500/30 rounded-lg text-sm text-sky-300 hover:text-sky-200 transition-all duration-200">BZS - South</button>
                        <button onclick="setClimateTDWG('BZE')" class="px-4 py-2 bg-sky-500/10 hover:bg-sky-500/20 border border-sky-500/30 rounded-lg text-sm text-sky-300 hover:text-sky-200 transition-all duration-200">BZE - Northeast</button>
                        <button onclick="setClimateTDWG('BZC')" class="px-4 py-2 bg-sky-500/10 hover:bg-sky-500/20 border border-sky-500/30 rounded-lg text-sm text-sky-300 hover:text-sky-200 transition-all duration-200">BZC - Central-West</button>
                        <button onclick="setClimateTDWG('BZL')" class="px-4 py-2 bg-sky-500/10 hover:bg-sky-500/20 border border-sky-500/30 rounded-lg text-sm text-sky-300 hover:text-sky-200 transition-all duration-200">BZL - Southeast</button>
                    </div>
                </div>

                <!-- Climate Result -->
                <div id="climate-result" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Climate Info Card -->
                        <div class="p-6 bg-sky-500/5 rounded-xl border border-sky-500/20">
                            <div class="flex items-center gap-4 mb-6">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-sky-500/20 to-cyan-500/20 flex items-center justify-center">
                                    <svg class="w-8 h-8 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-xl font-semibold text-white" id="climate-region-name">-</p>
                                    <p class="text-sky-400 font-mono text-sm" id="climate-region-code">-</p>
                                </div>
                            </div>

                            <!-- Biome & K√∂ppen -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="p-4 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                                    <p class="text-xs text-gray-400 mb-1">Whittaker Biome</p>
                                    <p class="text-lg font-semibold text-emerald-400" id="climate-biome">-</p>
                                </div>
                                <div class="p-4 bg-amber-500/10 rounded-lg border border-amber-500/20">
                                    <p class="text-xs text-gray-400 mb-1">K√∂ppen</p>
                                    <p class="text-lg font-semibold text-amber-400" id="climate-koppen">-</p>
                                </div>
                            </div>

                            <!-- Aridity -->
                            <div class="p-4 bg-purple-500/10 rounded-lg border border-purple-500/20">
                                <p class="text-xs text-gray-400 mb-1">Aridity Index</p>
                                <p class="text-2xl font-bold text-purple-400" id="climate-aridity">-</p>
                            </div>
                        </div>

                        <!-- Temperature & Precipitation -->
                        <div class="space-y-6">
                            <!-- Temperature -->
                            <div class="p-6 bg-rose-500/5 rounded-xl border border-rose-500/20">
                                <h4 class="text-sm font-semibold text-rose-400 mb-4 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5"/>
                                    </svg>
                                    Temperature (BIO1)
                                </h4>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-xs text-gray-400">Minimum</p>
                                        <p class="text-xl font-bold text-blue-400" id="climate-temp-min">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Mean</p>
                                        <p class="text-2xl font-bold text-rose-400" id="climate-temp-mean">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Maximum</p>
                                        <p class="text-xl font-bold text-orange-400" id="climate-temp-max">-</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Precipitation -->
                            <div class="p-6 bg-cyan-500/5 rounded-xl border border-cyan-500/20">
                                <h4 class="text-sm font-semibold text-cyan-400 mb-4 flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                                    </svg>
                                    Annual Precipitation (BIO12)
                                </h4>
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    <div>
                                        <p class="text-xs text-gray-400">Minimum</p>
                                        <p class="text-xl font-bold text-gray-400" id="climate-precip-min">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Mean</p>
                                        <p class="text-2xl font-bold text-cyan-400" id="climate-precip-mean">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400">Maximum</p>
                                        <p class="text-xl font-bold text-blue-400" id="climate-precip-max">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- All BIO Variables -->
                    <div class="mt-8 p-6 bg-white/5 rounded-xl border border-white/10">
                        <h4 class="text-sm font-semibold text-gray-300 mb-4">All Bioclimatic Variables</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm" id="climate-all-bio">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Climate Stats -->
                <div class="mt-8 pt-8 border-t border-white/10">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-md font-semibold text-gray-300">Global Climate Statistics</h3>
                        <button onclick="loadClimateStats()"
                                class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all duration-200">
                            Load Stats
                        </button>
                    </div>
                    <div id="climate-stats" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Biome Distribution -->
                        <div class="p-6 bg-emerald-500/5 rounded-xl border border-emerald-500/20">
                            <h4 class="text-sm font-semibold text-emerald-400 mb-4">Biome Distribution</h4>
                            <div id="biome-distribution" class="space-y-3">
                                <p class="text-gray-500 text-sm">Click "Load Stats"</p>
                            </div>
                        </div>
                        <!-- K√∂ppen Distribution -->
                        <div class="p-6 bg-amber-500/5 rounded-xl border border-amber-500/20">
                            <h4 class="text-sm font-semibold text-amber-400 mb-4">K√∂ppen Distribution</h4>
                            <div id="koppen-distribution" class="space-y-3">
                                <p class="text-gray-500 text-sm">Click "Load Stats"</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Location Query -->
        <section class="animate-slide-up" style="animation-delay: 0.2s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Location Query
            </h2>
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Latitude</label>
                        <input type="number" step="0.0001" id="lat-input" value="-27.5954"
                               class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-emerald-500/50 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-300">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Longitude</label>
                        <input type="number" step="0.0001" id="lon-input" value="-48.5480"
                               class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-emerald-500/50 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-300">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Growth Form</label>
                        <select id="growth-form-select"
                                class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-emerald-500/50 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-300">
                            <option value="">All</option>
                            <option value="tree">Trees</option>
                            <option value="shrub">Shrubs</option>
                            <option value="herb">Herbs</option>
                            <option value="climber">Climbers</option>
                            <option value="palm">Palms</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium">Results Limit</label>
                        <input type="number" id="limit-input" value="50" min="1" max="500"
                               class="w-full px-5 py-4 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-emerald-500/50 focus:ring-2 focus:ring-emerald-500/20 transition-all duration-300">
                    </div>
                    <div class="flex items-end">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="native-only" class="w-5 h-5 rounded bg-white/5 border-white/20 text-emerald-500 focus:ring-emerald-500/20">
                            <span class="text-gray-300 group-hover:text-white transition-colors">Native only</span>
                        </label>
                    </div>
                    <div class="flex items-end">
                        <button onclick="queryByLocation('tdwg')"
                                class="w-full px-6 py-4 bg-gradient-to-r from-emerald-600 to-cyan-600 hover:from-emerald-500 hover:to-cyan-500 text-white font-semibold rounded-xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 transition-all duration-300 transform hover:scale-[1.02]">
                            Search by TDWG
                        </button>
                    </div>
                    <div class="flex items-end">
                        <button onclick="queryByLocation('postgis')"
                                class="w-full px-6 py-4 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-semibold rounded-xl shadow-lg shadow-amber-500/20 hover:shadow-amber-500/40 transition-all duration-300 transform hover:scale-[1.02]">
                            Search by Geometry
                        </button>
                    </div>
                </div>

                <!-- Results Grid - Side by Side -->
                <div id="results-container" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- TDWG Results -->
                        <div id="tdwg-results" class="hidden">
                            <div class="p-6 bg-emerald-500/5 rounded-xl border border-emerald-500/20 mb-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500/20 to-cyan-500/20 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-sm">TDWG Method (Region)</p>
                                        <p class="text-xl font-semibold text-white" id="tdwg-name">-</p>
                                        <p class="text-emerald-400 font-mono text-sm" id="tdwg-code">-</p>
                                    </div>
                                    <div class="text-right">
                                        <span id="tdwg-count" class="text-3xl font-bold text-emerald-400">0</span>
                                        <p class="text-gray-400 text-sm">species</p>
                                        <p id="tdwg-time" class="text-xs text-gray-500"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-xl border border-white/10 max-h-96 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="sticky top-0">
                                        <tr class="bg-gray-900 border-b border-white/10">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300">Species</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300">Family</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300">Form</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tdwg-tbody" class="divide-y divide-white/5">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- PostGIS Results -->
                        <div id="postgis-results" class="hidden">
                            <div class="p-6 bg-amber-500/5 rounded-xl border border-amber-500/20 mb-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500/20 to-orange-500/20 flex items-center justify-center">
                                        <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-gray-400 text-sm">PostGIS Method (Geometry)</p>
                                        <p class="text-xl font-semibold text-white">Query Espacial Direta</p>
                                        <p class="text-amber-400 font-mono text-sm" id="postgis-coords">-</p>
                                    </div>
                                    <div class="text-right">
                                        <span id="postgis-count" class="text-3xl font-bold text-amber-400">0</span>
                                        <p class="text-gray-400 text-sm">species</p>
                                        <p id="postgis-time" class="text-xs text-gray-500"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto rounded-xl border border-white/10 max-h-96 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="sticky top-0">
                                        <tr class="bg-gray-900 border-b border-white/10">
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300">Species</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300">Family</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-300">Form</th>
                                        </tr>
                                    </thead>
                                    <tbody id="postgis-tbody" class="divide-y divide-white/5">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


<!-- Plant Diversity Recommendation System (HIDDEN - replaced by enhanced ecoregion lookup) -->
<section class="hidden animate-slide-up" style="animation-delay: 0.25s">
    <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
        </svg>
        <span data-i18n="recommend.title">Plant Diversity Recommendation</span>
    </h2>

    <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
        <!-- Language Toggle -->
        <div class="mb-6 flex justify-end">
            <div class="inline-flex rounded-lg border border-white/10 bg-white/5 p-1">
                <button onclick="setLanguage('en')" id="lang-en"
                        class="px-3 py-1.5 rounded-md text-sm transition-all duration-300 text-gray-300">
                    English
                </button>
                <button onclick="setLanguage('pt')" id="lang-pt"
                        class="px-3 py-1.5 rounded-md text-sm transition-all duration-300 bg-emerald-600 text-white">
                    Portugu√™s
                </button>
            </div>
        </div>

        <!-- Location Input -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            <div class="space-y-2">
                <label class="text-sm text-gray-400 font-medium" data-i18n="recommend.location">
                    Location (TDWG or State)
                </label>
                <input type="text" id="rec-location" placeholder="BZS or BR-SC"
                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all">
            </div>
            <div class="space-y-2">
                <label class="text-sm text-gray-400 font-medium" data-i18n="recommend.latitude">
                    Or Latitude
                </label>
                <input type="number" step="0.0001" id="rec-lat" placeholder="-25.4284"
                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all">
            </div>
            <div class="space-y-2">
                <label class="text-sm text-gray-400 font-medium" data-i18n="recommend.longitude">
                    Longitude
                </label>
                <input type="number" step="0.0001" id="rec-lon" placeholder="-49.2733"
                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all">
            </div>
            <div class="space-y-2">
                <label class="text-sm text-gray-400 font-medium" data-i18n="recommend.n_species">
                    Number of Species
                </label>
                <input type="number" min="5" max="1000" step="1" value="20" id="rec-n-species"
                       class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:border-emerald-500 focus:ring-2 focus:ring-emerald-500/20 transition-all">
            </div>
        </div>

        <!-- Filters -->
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-emerald-400 mb-3" data-i18n="recommend.filters">
                Filters (Optional)
            </h3>
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" value="tree" class="rec-growth-form rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.tree">Trees</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" value="shrub" class="rec-growth-form rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.shrub">Shrubs</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" value="herb" class="rec-growth-form rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.herb">Herbs</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" id="rec-n-fixers" class="rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.n_fixers">Nitrogen Fixers Only</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" id="rec-exclude-threatened" class="rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.exclude_threatened">Exclude Threatened</span>
                </label>
            </div>
            <!-- Second row of filters -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mt-3">
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" value="climber" class="rec-growth-form rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.climber">Climbers</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" value="palm" class="rec-growth-form rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.palm">Palms</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer hover:text-emerald-400 transition-colors">
                    <input type="checkbox" id="rec-include-introduced" class="rounded border-white/20 text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="recommend.include_introduced">Include Introduced</span>
                    <span class="text-xs text-amber-400" title="For agricultural species like corn, tomato">üåæ</span>
                </label>
                <div></div> <!-- Spacer -->
                <div></div> <!-- Spacer -->
            </div>
        </div>

        <!-- Climate Threshold Slider -->
        <div class="mb-6">
            <label class="text-sm text-gray-400 font-medium mb-2 block">
                <span data-i18n="recommend.climate_threshold">Climate Match Threshold:</span>
                <span id="climate-threshold-value" class="text-emerald-400 font-semibold ml-2">0.6</span>
            </label>
            <input type="range" min="0.3" max="0.9" step="0.1" value="0.6" id="rec-climate-threshold"
                   class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                   oninput="document.getElementById('climate-threshold-value').textContent = this.value" />
            <div class="flex justify-between text-xs text-gray-500 mt-2">
                <span data-i18n="recommend.experimental">Experimental (0.3)</span>
                <span data-i18n="recommend.moderate">Moderate (0.5)</span>
                <span data-i18n="recommend.strict">Strict (0.7+)</span>
            </div>
        </div>

        <button onclick="generateRecommendations()"
                class="w-full px-6 py-4 bg-gradient-to-r from-emerald-600 to-cyan-600 hover:from-emerald-500 hover:to-cyan-500 text-white font-semibold rounded-xl shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98]">
            üå± <span data-i18n="recommend.generate">Generate Recommendations</span>
        </button>

        <!-- Loading -->
        <div id="rec-loading" class="hidden mt-8 text-center py-12">
            <div class="inline-block w-12 h-12 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin"></div>
            <p class="mt-4 text-gray-400 animate-pulse" data-i18n="recommend.loading">Calculating optimal diversity...</p>
        </div>

        <!-- Results -->
        <div id="rec-results" class="mt-8 hidden">
            <!-- Diversity Metrics Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-br from-cyan-900/40 to-cyan-800/20 rounded-xl p-5 border border-cyan-500/20 hover:border-cyan-500/40 transition-all">
                    <div class="text-3xl font-bold text-cyan-400" id="metric-functional">0%</div>
                    <div class="text-xs text-gray-400 mt-1" data-i18n="recommend.functional_div">Functional Diversity</div>
                </div>
                <div class="bg-gradient-to-br from-emerald-900/40 to-emerald-800/20 rounded-xl p-5 border border-emerald-500/20 hover:border-emerald-500/40 transition-all">
                    <div class="text-3xl font-bold text-emerald-400" id="metric-families">0</div>
                    <div class="text-xs text-gray-400 mt-1" data-i18n="recommend.families">Families</div>
                </div>
                <div class="bg-gradient-to-br from-purple-900/40 to-purple-800/20 rounded-xl p-5 border border-purple-500/20 hover:border-purple-500/40 transition-all">
                    <div class="text-3xl font-bold text-purple-400" id="metric-growth-forms">0</div>
                    <div class="text-xs text-gray-400 mt-1" data-i18n="recommend.growth_forms">Growth Forms</div>
                </div>
                <div class="bg-gradient-to-br from-rose-900/40 to-rose-800/20 rounded-xl p-5 border border-rose-500/20 hover:border-rose-500/40 transition-all">
                    <div class="text-3xl font-bold text-rose-400" id="metric-total-score">0%</div>
                    <div class="text-xs text-gray-400 mt-1" data-i18n="recommend.total_score">Total Score</div>
                </div>
            </div>

            <!-- Species Table -->
            <div class="bg-white/5 rounded-xl overflow-hidden border border-white/10">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-white/5 border-b border-white/10">
                            <tr class="text-left text-xs text-gray-400 uppercase tracking-wider">
                                <th class="px-4 py-3 font-semibold">#</th>
                                <th class="px-4 py-3 font-semibold" data-i18n="recommend.species">Species</th>
                                <th class="px-4 py-3 font-semibold" data-i18n="recommend.family">Family</th>
                                <th class="px-4 py-3 font-semibold" data-i18n="recommend.form">Form</th>
                                <th class="px-4 py-3 text-center font-semibold" data-i18n="recommend.climate">Climate</th>
                                <th class="px-4 py-3 text-center font-semibold" data-i18n="recommend.diversity">Diversity+</th>
                                <th class="px-4 py-3 text-center font-semibold">N-Fix</th>
                            </tr>
                        </thead>
                        <tbody id="rec-species-table" class="divide-y divide-white/5">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Query Time -->
            <div class="mt-4 text-center text-sm text-gray-500">
                <span data-i18n="recommend.query_time">Query time:</span> <span id="rec-query-time" class="text-emerald-400 font-mono">-</span>
            </div>
        </div>
    </div>
</section>

<script>
// ============================================================================
// INTERNATIONALIZATION
// ============================================================================

const i18n = {
    en: {
        'recommend.title': 'Plant Diversity Recommendation',
        'recommend.location': 'Location (TDWG or State)',
        'recommend.latitude': 'Or Latitude',
        'recommend.longitude': 'Longitude',
        'recommend.n_species': 'Number of Species',
        'recommend.filters': 'Filters (Optional)',
        'recommend.tree': 'Trees',
        'recommend.shrub': 'Shrubs',
        'recommend.herb': 'Herbs',
        'recommend.climber': 'Climbers',
        'recommend.palm': 'Palms',
        'recommend.n_fixers': 'Nitrogen Fixers Only',
        'recommend.exclude_threatened': 'Exclude Threatened',
        'recommend.include_introduced': 'Include Introduced',
        'recommend.climate_threshold': 'Climate Match Threshold:',
        'recommend.experimental': 'Experimental (0.3)',
        'recommend.moderate': 'Moderate (0.5)',
        'recommend.strict': 'Strict (0.7+)',
        'recommend.generate': 'Generate Recommendations',
        'recommend.loading': 'Calculating optimal diversity...',
        'recommend.functional_div': 'Functional Diversity',
        'recommend.families': 'Families',
        'recommend.growth_forms': 'Growth Forms',
        'recommend.total_score': 'Total Score',
        'recommend.species': 'Species',
        'recommend.family': 'Family',
        'recommend.form': 'Form',
        'recommend.climate': 'Climate',
        'recommend.diversity': 'Diversity+',
        'recommend.query_time': 'Query time:',
        'ecoregion.title': 'Climate-Adapted Species Filter',
        'ecoregion.description': 'Find climatically adapted plant species for any terrestrial location. Click on the map or enter coordinates. Filters species by climate envelope matching using WorldClim data and ecoregion distributions.',
        'ecoregion.map_hint': 'Click on the map to select a location, or enter coordinates below',
        'ecoregion.latitude': 'Latitude',
        'ecoregion.longitude': 'Longitude',
        'ecoregion.limit': 'Max Species',
        'ecoregion.threshold': 'Climate Match Threshold:',
        'ecoregion.experimental': 'Experimental',
        'ecoregion.strict': 'Strict',
        'ecoregion.growth_forms': 'Filter by Growth Form',
        'ecoregion.trees': 'Trees',
        'ecoregion.shrubs': 'Shrubs',
        'ecoregion.herbs': 'Herbs',
        'ecoregion.climbers': 'Climbers',
        'ecoregion.palms': 'Palms',
        'ecoregion.search': 'Search Climate-Adapted Species',
        'ecoregion.loading': 'Analyzing climate adaptation...',
        'ecoregion.species_shown': 'Species shown',
        'ecoregion.total_in_biome': 'total in biome',
        'ecoregion.query_time': 'Query time',
        'ecoregion.temp_mean': 'Mean Temp (¬∞C)',
        'ecoregion.temp_max': 'Max Temp (¬∞C)',
        'ecoregion.temp_min': 'Min Temp (¬∞C)',
        'ecoregion.precip': 'Precip (mm/yr)',
        'ecoregion.seasonality': 'Seasonality',
        'ecoregion.species': 'Species',
        'ecoregion.family': 'Family',
        'ecoregion.form': 'Form',
        'ecoregion.climate_match': 'Climate Match',
        'ecoregion.ecoregions': 'Ecoregions',
        'ecoregion.observations': 'Observations',
        'ecoregion.export_csv': 'Export CSV',
        'ecoregion.copy': 'Copy to Clipboard'
    },
    pt: {
        'recommend.title': 'Recomenda√ß√£o de Plantas para Diversidade',
        'recommend.location': 'Localiza√ß√£o (TDWG ou Estado)',
        'recommend.latitude': 'Ou Latitude',
        'recommend.longitude': 'Longitude',
        'recommend.n_species': 'N√∫mero de Esp√©cies',
        'recommend.filters': 'Filtros (Opcional)',
        'recommend.tree': '√Årvores',
        'recommend.shrub': 'Arbustos',
        'recommend.herb': 'Herb√°ceas',
        'recommend.climber': 'Trepadeiras',
        'recommend.palm': 'Palmeiras',
        'recommend.n_fixers': 'Apenas Fixadores de N‚ÇÇ',
        'recommend.exclude_threatened': 'Excluir Amea√ßadas',
        'recommend.include_introduced': 'Incluir Introduzidas',
        'recommend.climate_threshold': 'Limiar de Adapta√ß√£o Clim√°tica:',
        'recommend.experimental': 'Experimental (0.3)',
        'recommend.moderate': 'Moderado (0.5)',
        'recommend.strict': 'Restrito (0.7+)',
        'recommend.generate': 'Gerar Recomenda√ß√µes',
        'recommend.loading': 'Calculando diversidade √≥tima...',
        'recommend.functional_div': 'Diversidade Funcional',
        'recommend.families': 'Fam√≠lias',
        'recommend.growth_forms': 'Formas de Crescimento',
        'recommend.total_score': 'Score Total',
        'recommend.species': 'Esp√©cie',
        'recommend.family': 'Fam√≠lia',
        'recommend.form': 'Forma',
        'recommend.climate': 'Clima',
        'recommend.diversity': 'Diversidade+',
        'recommend.query_time': 'Tempo de consulta:',
        'ecoregion.title': 'Filtro de Esp√©cies Adaptadas ao Clima',
        'ecoregion.description': 'Encontre esp√©cies de plantas climaticamente adaptadas para qualquer localiza√ß√£o terrestre. Clique no mapa ou insira coordenadas. Filtra esp√©cies por envelope clim√°tico usando dados WorldClim e distribui√ß√£o por ecorregi√µes.',
        'ecoregion.map_hint': 'Clique no mapa para selecionar uma localiza√ß√£o, ou insira coordenadas abaixo',
        'ecoregion.latitude': 'Latitude',
        'ecoregion.longitude': 'Longitude',
        'ecoregion.limit': 'M√°x. Esp√©cies',
        'ecoregion.threshold': 'Limiar de Adapta√ß√£o Clim√°tica:',
        'ecoregion.experimental': 'Experimental',
        'ecoregion.strict': 'Restrito',
        'ecoregion.growth_forms': 'Filtrar por Forma de Crescimento',
        'ecoregion.trees': '√Årvores',
        'ecoregion.shrubs': 'Arbustos',
        'ecoregion.herbs': 'Herb√°ceas',
        'ecoregion.climbers': 'Trepadeiras',
        'ecoregion.palms': 'Palmeiras',
        'ecoregion.search': 'Buscar Esp√©cies Adaptadas ao Clima',
        'ecoregion.loading': 'Analisando adapta√ß√£o clim√°tica...',
        'ecoregion.species_shown': 'Esp√©cies mostradas',
        'ecoregion.total_in_biome': 'total no bioma',
        'ecoregion.query_time': 'Tempo de consulta',
        'ecoregion.temp_mean': 'Temp M√©dia (¬∞C)',
        'ecoregion.temp_max': 'Temp M√°x (¬∞C)',
        'ecoregion.temp_min': 'Temp M√≠n (¬∞C)',
        'ecoregion.precip': 'Precip (mm/ano)',
        'ecoregion.seasonality': 'Sazonalidade',
        'ecoregion.species': 'Esp√©cie',
        'ecoregion.family': 'Fam√≠lia',
        'ecoregion.form': 'Forma',
        'ecoregion.climate_match': 'Adapta√ß√£o Clim√°tica',
        'ecoregion.ecoregions': 'Ecorregi√µes',
        'ecoregion.observations': 'Observa√ß√µes',
        'ecoregion.export_csv': 'Exportar CSV',
        'ecoregion.copy': 'Copiar'
    }
};

let currentLang = 'pt';

function setLanguage(lang) {
    currentLang = lang;
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang] && i18n[lang][key]) {
            el.textContent = i18n[lang][key];
        }
    });

    // Update all language toggle button styles
    const langButtons = [
        { en: 'lang-en', pt: 'lang-pt' },
        { en: 'eco-lang-en', pt: 'eco-lang-pt' }
    ];

    langButtons.forEach(pair => {
        const enBtn = document.getElementById(pair.en);
        const ptBtn = document.getElementById(pair.pt);

        if (enBtn) {
            enBtn.classList.toggle('bg-emerald-600', lang === 'en');
            enBtn.classList.toggle('text-white', lang === 'en');
            enBtn.classList.toggle('text-gray-300', lang !== 'en');
        }
        if (ptBtn) {
            ptBtn.classList.toggle('bg-emerald-600', lang === 'pt');
            ptBtn.classList.toggle('text-white', lang === 'pt');
            ptBtn.classList.toggle('text-gray-300', lang !== 'pt');
        }
    });
}

// ============================================================================
// RECOMMENDATION FUNCTIONS
// ============================================================================

async function generateRecommendations() {
    const location = document.getElementById('rec-location').value;
    const lat = parseFloat(document.getElementById('rec-lat').value);
    const lon = parseFloat(document.getElementById('rec-lon').value);
    const nSpecies = parseInt(document.getElementById('rec-n-species').value) || 20;
    const climateThreshold = parseFloat(document.getElementById('rec-climate-threshold').value);

    const selectedForms = Array.from(document.querySelectorAll('.rec-growth-form:checked'))
        .map(cb => cb.value);
    const growthForms = expandGrowthForms(selectedForms);

    const preferences = {
        growth_forms: growthForms.length > 0 ? growthForms : undefined,
        include_introduced: document.getElementById('rec-include-introduced').checked,
        nitrogen_fixers_only: document.getElementById('rec-n-fixers').checked,
        include_threatened: !document.getElementById('rec-exclude-threatened').checked
    };

    const requestBody = {
        n_species: nSpecies,
        climate_threshold: climateThreshold,
        preferences: preferences
    };

    // Determine location input method
    if (location) {
        if (location.startsWith('BR-')) {
            requestBody.state_code = location;
        } else {
            requestBody.tdwg_code = location;
        }
    } else if (!isNaN(lat) && !isNaN(lon)) {
        requestBody.latitude = lat;
        requestBody.longitude = lon;
    } else {
        alert(currentLang === 'pt' ?
            'Por favor, forne√ßa um c√≥digo de localiza√ß√£o ou coordenadas' :
            'Please provide a location code or coordinates');
        return;
    }

    // Show loading
    document.getElementById('rec-loading').classList.remove('hidden');
    document.getElementById('rec-results').classList.add('hidden');

    try {
        const response = await fetch(`${API_BASE}/api/recommend`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Recommendation failed');
        }

        const data = await response.json();
        displayRecommendations(data);
    } catch (error) {
        console.error('Error:', error);
        alert(currentLang === 'pt' ?
            `Erro ao gerar recomenda√ß√µes: ${error.message}` :
            `Failed to generate recommendations: ${error.message}`);
    } finally {
        document.getElementById('rec-loading').classList.add('hidden');
    }
}

function displayRecommendations(data) {
    document.getElementById('rec-results').classList.remove('hidden');

    // Update metrics
    const metrics = data.diversity_metrics;
    document.getElementById('metric-functional').textContent =
        (metrics.functional_diversity * 100).toFixed(0) + '%';
    document.getElementById('metric-families').textContent = metrics.n_families;
    document.getElementById('metric-growth-forms').textContent = metrics.n_growth_forms;
    document.getElementById('metric-total-score').textContent =
        (metrics.total_diversity_score * 100).toFixed(0) + '%';

    // Update query time
    document.getElementById('rec-query-time').textContent = data.query_time;

    // Populate species table
    const tableBody = document.getElementById('rec-species-table');
    tableBody.innerHTML = data.species.map(sp => {
        const commonName = currentLang === 'pt' ? sp.common_name_pt : sp.common_name_en;
        const growthFormEmoji = {
            'tree': 'üå≤',
            'shrub': 'üå≥',
            'herb': 'üåø',
            'climber': 'üå±',
            'palm': 'üå¥'
        };
        const emoji = growthFormEmoji[sp.growth_form] || 'üå±';

        return `
            <tr class="table-row hover:bg-white/5 transition-colors">
                <td class="px-4 py-3 text-sm text-gray-400 font-mono">${sp.selection_rank}</td>
                <td class="px-4 py-3">
                    <div class="font-semibold text-white">${sp.canonical_name}</div>
                    ${commonName ? `<div class="text-xs text-emerald-400 mt-0.5">üáßüá∑ ${commonName}</div>` : ''}
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">${sp.family}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-medium">
                        ${emoji} ${sp.growth_form}
                    </span>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="text-cyan-400 font-semibold">${(sp.climate_match_score * 100).toFixed(0)}%</div>
                    <div class="w-full bg-white/10 rounded-full h-1.5 mt-1">
                        <div class="bg-cyan-500 h-full rounded-full" style="width: ${(sp.climate_match_score * 100)}%"></div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="text-purple-400 font-semibold">${(sp.diversity_contribution * 100).toFixed(0)}%</div>
                    <div class="w-full bg-white/10 rounded-full h-1.5 mt-1">
                        <div class="bg-purple-500 h-full rounded-full" style="width: ${(sp.diversity_contribution * 100)}%"></div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center text-lg">
                    ${sp.is_nitrogen_fixer ? '<span title="Nitrogen fixer">‚úÖ</span>' : '<span class="text-gray-600">‚Äî</span>'}
                </td>
            </tr>
        `;
    }).join('');

    // Scroll to results
    document.getElementById('rec-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>

        <!-- Climate-Adapted Species Filter -->
        <section class="animate-slide-up" style="animation-delay: 0.35s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span data-i18n="ecoregion.title">Climate-Adapted Species Filter</span>
            </h2>
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <!-- Language Toggle -->
                <div class="flex justify-between items-start mb-6">
                    <p class="text-gray-400 text-sm max-w-2xl" data-i18n="ecoregion.description">
                        Find climatically adapted plant species for any terrestrial location. Click on the map or enter coordinates. Filters species by climate envelope matching using WorldClim data and ecoregion distributions.
                    </p>
                    <div class="inline-flex rounded-lg border border-white/10 bg-white/5 p-1 ml-4 flex-shrink-0">
                        <button onclick="setLanguage('en')" id="eco-lang-en"
                                class="px-3 py-1.5 rounded-md text-sm transition-all duration-300 text-gray-300">
                            EN
                        </button>
                        <button onclick="setLanguage('pt')" id="eco-lang-pt"
                                class="px-3 py-1.5 rounded-md text-sm transition-all duration-300 bg-emerald-600 text-white">
                            PT
                        </button>
                    </div>
                </div>

                <!-- Interactive Map -->
                <div class="mb-6">
                    <div id="eco-map" class="w-full h-80 rounded-xl border border-white/10 overflow-hidden" style="background: #1a1a2e;"></div>
                    <p class="text-xs text-gray-500 mt-2 text-center" data-i18n="ecoregion.map_hint">
                        Click on the map to select a location, or enter coordinates below
                    </p>
                </div>

                <!-- Input Form -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-4 mb-6">
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium" data-i18n="ecoregion.latitude">Latitude</label>
                        <input type="number" step="0.0001" id="eco-lat" placeholder="-25.4284"
                               class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-amber-500/50 transition-all duration-300">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium" data-i18n="ecoregion.longitude">Longitude</label>
                        <input type="number" step="0.0001" id="eco-lon" placeholder="-49.2733"
                               class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-amber-500/50 transition-all duration-300">
                    </div>
                    <div class="space-y-2">
                        <label class="text-sm text-gray-400 font-medium" data-i18n="ecoregion.limit">Max Species</label>
                        <input type="number" min="10" max="1000" step="1" value="100" id="eco-limit"
                               class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-amber-500/50 transition-all duration-300">
                    </div>
                    <div class="space-y-2 col-span-2">
                        <label class="text-sm text-gray-400 font-medium">
                            <span data-i18n="ecoregion.threshold">Climate Match Threshold:</span>
                            <span id="eco-threshold-value" class="text-amber-400 ml-1">0.5</span>
                            <span class="text-gray-500 text-xs ml-2" id="eco-threshold-label">(Moderate)</span>
                        </label>
                        <input type="range" min="0.3" max="0.9" step="0.1" value="0.5" id="eco-threshold"
                               class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-amber-500"
                               oninput="updateThresholdLabel(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span data-i18n="ecoregion.experimental">Experimental</span>
                            <span data-i18n="ecoregion.strict">Strict</span>
                        </div>
                    </div>
                </div>

                <!-- Growth Form Filters -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-amber-400 mb-3" data-i18n="ecoregion.growth_forms">
                        Filter by Growth Form
                    </h3>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-lg border border-white/10 cursor-pointer hover:border-amber-500/50 transition-all has-[:checked]:bg-amber-500/20 has-[:checked]:border-amber-500/50">
                            <input type="checkbox" value="tree" class="eco-growth-form rounded border-white/20 text-amber-600 focus:ring-amber-500" checked>
                            <span class="text-sm text-gray-300">üå≤ <span data-i18n="ecoregion.trees">Trees</span></span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-lg border border-white/10 cursor-pointer hover:border-amber-500/50 transition-all has-[:checked]:bg-amber-500/20 has-[:checked]:border-amber-500/50">
                            <input type="checkbox" value="shrub" class="eco-growth-form rounded border-white/20 text-amber-600 focus:ring-amber-500" checked>
                            <span class="text-sm text-gray-300">üå≥ <span data-i18n="ecoregion.shrubs">Shrubs</span></span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-lg border border-white/10 cursor-pointer hover:border-amber-500/50 transition-all has-[:checked]:bg-amber-500/20 has-[:checked]:border-amber-500/50">
                            <input type="checkbox" value="herb" class="eco-growth-form rounded border-white/20 text-amber-600 focus:ring-amber-500">
                            <span class="text-sm text-gray-300">üåø <span data-i18n="ecoregion.herbs">Herbs</span></span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-lg border border-white/10 cursor-pointer hover:border-amber-500/50 transition-all has-[:checked]:bg-amber-500/20 has-[:checked]:border-amber-500/50">
                            <input type="checkbox" value="climber" class="eco-growth-form rounded border-white/20 text-amber-600 focus:ring-amber-500">
                            <span class="text-sm text-gray-300">üå± <span data-i18n="ecoregion.climbers">Climbers</span></span>
                        </label>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-lg border border-white/10 cursor-pointer hover:border-amber-500/50 transition-all has-[:checked]:bg-amber-500/20 has-[:checked]:border-amber-500/50">
                            <input type="checkbox" value="palm" class="eco-growth-form rounded border-white/20 text-amber-600 focus:ring-amber-500">
                            <span class="text-sm text-gray-300">üå¥ <span data-i18n="ecoregion.palms">Palms</span></span>
                        </label>
                    </div>
                </div>

                <button onclick="lookupEcoregionSpecies()"
                        class="w-full px-6 py-4 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-semibold rounded-xl shadow-lg shadow-amber-500/20 hover:shadow-amber-500/40 transition-all duration-300 transform hover:scale-[1.02]">
                    üåç <span data-i18n="ecoregion.search">Search Climate-Adapted Species</span>
                </button>

                <!-- Loading -->
                <div id="eco-loading" class="hidden mt-8 text-center py-8">
                    <div class="inline-block w-10 h-10 border-4 border-amber-500/30 border-t-amber-500 rounded-full animate-spin"></div>
                    <p class="mt-4 text-gray-400" data-i18n="ecoregion.loading">Analyzing climate adaptation...</p>
                </div>

                <!-- Results -->
                <div id="eco-results" class="mt-8 hidden">
                    <!-- Ecoregion Info Card -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-amber-900/40 to-amber-800/20 rounded-xl p-5 border border-amber-500/20 col-span-2">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="text-xl font-bold text-amber-400" id="eco-name">-</div>
                                    <div class="text-sm text-gray-400 mt-1" id="eco-biome">-</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-500" id="eco-realm">-</div>
                                    <div class="text-xs text-amber-400/70 mt-1" id="eco-coords">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-cyan-900/40 to-cyan-800/20 rounded-xl p-5 border border-cyan-500/20">
                            <div class="text-3xl font-bold text-cyan-400" id="eco-species-count">0</div>
                            <div class="text-xs text-gray-400 mt-1" data-i18n="ecoregion.species_shown">Species shown</div>
                            <div class="text-xs text-gray-500 mt-1"><span id="eco-total-biome">0</span> <span data-i18n="ecoregion.total_in_biome">total in biome</span></div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-900/40 to-emerald-800/20 rounded-xl p-5 border border-emerald-500/20">
                            <div class="text-3xl font-bold text-emerald-400" id="eco-query-time">-</div>
                            <div class="text-xs text-gray-400 mt-1" data-i18n="ecoregion.query_time">Query time</div>
                        </div>
                    </div>

                    <!-- Climate Info -->
                    <div class="grid grid-cols-5 gap-3 mb-6 text-center">
                        <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                            <div class="text-xl font-semibold text-emerald-400" id="eco-bio1">-</div>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="ecoregion.temp_mean">Mean Temp (¬∞C)</div>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                            <div class="text-xl font-semibold text-red-400" id="eco-bio5">-</div>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="ecoregion.temp_max">Max Temp (¬∞C)</div>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                            <div class="text-xl font-semibold text-blue-400" id="eco-bio6">-</div>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="ecoregion.temp_min">Min Temp (¬∞C)</div>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                            <div class="text-xl font-semibold text-cyan-400" id="eco-bio12">-</div>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="ecoregion.precip">Precip (mm/yr)</div>
                        </div>
                        <div class="bg-white/5 rounded-lg p-3 border border-white/5">
                            <div class="text-xl font-semibold text-purple-400" id="eco-bio15">-</div>
                            <div class="text-xs text-gray-500 mt-1" data-i18n="ecoregion.seasonality">Seasonality</div>
                        </div>
                    </div>

                    <!-- Species Table -->
                    <div class="bg-white/5 rounded-xl overflow-hidden border border-white/10">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-white/5 border-b border-white/10">
                                    <tr class="text-left text-xs text-gray-400 uppercase tracking-wider">
                                        <th class="px-4 py-3 font-semibold">#</th>
                                        <th class="px-4 py-3 font-semibold" data-i18n="ecoregion.species">Species</th>
                                        <th class="px-4 py-3 font-semibold" data-i18n="ecoregion.family">Family</th>
                                        <th class="px-4 py-3 font-semibold" data-i18n="ecoregion.form">Form</th>
                                        <th class="px-4 py-3 text-center font-semibold" data-i18n="ecoregion.climate_match">Climate Match</th>
                                        <th class="px-4 py-3 text-center font-semibold" data-i18n="ecoregion.ecoregions">Ecoregions</th>
                                        <th class="px-4 py-3 text-center font-semibold" data-i18n="ecoregion.observations">Observations</th>
                                    </tr>
                                </thead>
                                <tbody id="eco-species-table" class="divide-y divide-white/5">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Export buttons -->
                    <div class="mt-4 flex justify-end gap-3">
                        <button onclick="exportSpeciesCSV()" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all">
                            üìÑ <span data-i18n="ecoregion.export_csv">Export CSV</span>
                        </button>
                        <button onclick="copySpeciesToClipboard()" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all">
                            üìã <span data-i18n="ecoregion.copy">Copy to Clipboard</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

<script>
// ============================================================================
// ECOREGION MAP & SPECIES LOOKUP
// ============================================================================

// Helper function to expand growth forms (shared by both sections)
function expandGrowthForms(forms) {
    const expanded = new Set(forms);

    // Auto-expand "herb" to include forb and graminoid
    if (forms.includes('herb')) {
        expanded.add('forb');
        expanded.add('graminoid');
    }

    return Array.from(expanded);
}

let ecoMap = null;
let ecoMarker = null;
let lastEcoData = null;

// Initialize map when page loads
document.addEventListener('DOMContentLoaded', function() {
    initEcoMap();
});

function initEcoMap() {
    // Initialize Leaflet map
    ecoMap = L.map('eco-map', {
        center: [-15.0, -55.0], // Brazil center
        zoom: 4,
        minZoom: 2,
        maxZoom: 18
    });

    // Add tile layer (OpenStreetMap standard - clear and readable)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19
    }).addTo(ecoMap);

    // Add click handler
    ecoMap.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(4);
        const lon = e.latlng.lng.toFixed(4);

        // Update input fields
        document.getElementById('eco-lat').value = lat;
        document.getElementById('eco-lon').value = lon;

        // Update marker
        updateEcoMarker(e.latlng.lat, e.latlng.lng);
    });

    // Add scale control
    L.control.scale({ imperial: false }).addTo(ecoMap);
}

function updateEcoMarker(lat, lon) {
    if (ecoMarker) {
        ecoMarker.setLatLng([lat, lon]);
    } else {
        ecoMarker = L.marker([lat, lon], {
            icon: L.divIcon({
                className: 'eco-marker',
                html: '<div style="background: #f59e0b; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.5);"></div>',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            })
        }).addTo(ecoMap);
    }
}

function updateThresholdLabel(value) {
    const val = parseFloat(value);
    document.getElementById('eco-threshold-value').textContent = val;

    let label = '';
    if (val <= 0.4) label = currentLang === 'pt' ? '(Experimental)' : '(Experimental)';
    else if (val <= 0.6) label = currentLang === 'pt' ? '(Moderado)' : '(Moderate)';
    else label = currentLang === 'pt' ? '(Restrito)' : '(Strict)';

    document.getElementById('eco-threshold-label').textContent = label;
}

async function lookupEcoregionSpecies() {
    const lat = parseFloat(document.getElementById('eco-lat').value);
    const lon = parseFloat(document.getElementById('eco-lon').value);
    const limit = parseInt(document.getElementById('eco-limit').value) || 100;
    const threshold = parseFloat(document.getElementById('eco-threshold').value) || 0.5;

    // Get selected growth forms and expand "herb" automatically
    const selectedForms = Array.from(document.querySelectorAll('.eco-growth-form:checked'))
        .map(cb => cb.value);
    const growthForms = expandGrowthForms(selectedForms);

    if (isNaN(lat) || isNaN(lon)) {
        alert(currentLang === 'pt' ? 'Por favor, forne√ßa coordenadas v√°lidas' : 'Please provide valid coordinates');
        return;
    }

    if (lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert(currentLang === 'pt' ? 'Coordenadas fora do intervalo v√°lido' : 'Coordinates out of valid range');
        return;
    }

    // Update map marker
    updateEcoMarker(lat, lon);
    ecoMap.setView([lat, lon], Math.max(ecoMap.getZoom(), 6));

    // Show loading
    document.getElementById('eco-loading').classList.remove('hidden');
    document.getElementById('eco-results').classList.add('hidden');

    try {
        const response = await fetch('/api/ecoregion/species', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                latitude: lat,
                longitude: lon,
                limit: limit,
                climate_threshold: threshold,
                growth_forms: growthForms.length > 0 ? growthForms : null
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || 'Request failed');
        }

        const data = await response.json();
        lastEcoData = data;
        displayEcoregionResults(data, growthForms);
    } catch (error) {
        console.error('Error:', error);
        alert(currentLang === 'pt' ?
            `Erro: ${error.message}` :
            `Error: ${error.message}`);
    } finally {
        document.getElementById('eco-loading').classList.add('hidden');
    }
}

function displayEcoregionResults(data, growthForms) {
    document.getElementById('eco-results').classList.remove('hidden');

    // Ecoregion info
    document.getElementById('eco-name').textContent = data.ecoregion.eco_name;
    document.getElementById('eco-biome').textContent = data.ecoregion.biome_name;
    document.getElementById('eco-realm').textContent = data.ecoregion.realm;
    document.getElementById('eco-coords').textContent = `${data.ecoregion.latitude.toFixed(4)}¬∞, ${data.ecoregion.longitude.toFixed(4)}¬∞`;

    // Filter species by growth form if specified
    let filteredSpecies = data.species || [];
    if (growthForms && growthForms.length > 0) {
        filteredSpecies = filteredSpecies.filter(sp => {
            const form = (sp.growth_form || 'tree').toLowerCase();
            return growthForms.some(gf => form.includes(gf));
        });
    }

    // Species counts
    document.getElementById('eco-species-count').textContent = filteredSpecies.length;
    document.getElementById('eco-total-biome').textContent = data.total_in_biome.toLocaleString();

    // Query time
    document.getElementById('eco-query-time').textContent = data.query_time || '-';

    // Climate data
    document.getElementById('eco-bio1').textContent = data.climate.bio1 ? data.climate.bio1.toFixed(1) : '-';
    document.getElementById('eco-bio5').textContent = data.climate.bio5 ? data.climate.bio5.toFixed(1) : '-';
    document.getElementById('eco-bio6').textContent = data.climate.bio6 ? data.climate.bio6.toFixed(1) : '-';
    document.getElementById('eco-bio12').textContent = data.climate.bio12 ? Math.round(data.climate.bio12).toLocaleString() : '-';
    document.getElementById('eco-bio15').textContent = data.climate.bio15 ? data.climate.bio15.toFixed(1) : '-';

    // Species table
    const tableBody = document.getElementById('eco-species-table');
    if (filteredSpecies.length === 0) {
        const noDataMsg = currentLang === 'pt'
            ? 'Nenhuma esp√©cie encontrada com os crit√©rios selecionados'
            : 'No species found matching the selected criteria';
        tableBody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">${noDataMsg}</td></tr>`;
        return;
    }

    const growthFormEmoji = {
        'tree': 'üå≤',
        'shrub': 'üå≥',
        'herb': 'üåø',
        'climber': 'üå±',
        'palm': 'üå¥',
        'other': 'üåæ'
    };

    tableBody.innerHTML = filteredSpecies.map((sp, idx) => {
        const climatePercent = (sp.climate_match_score * 100).toFixed(0);
        const climateClass = sp.climate_match_score >= 0.8 ? 'text-emerald-400' :
                            sp.climate_match_score >= 0.6 ? 'text-cyan-400' :
                            sp.climate_match_score >= 0.5 ? 'text-amber-400' : 'text-red-400';
        const form = sp.growth_form || 'tree';
        const emoji = growthFormEmoji[form.toLowerCase()] || 'üå±';

        // Additional info line
        let infoLine = [];
        if (sp.max_height_m) infoLine.push(`${sp.max_height_m}m`);
        if (sp.lifespan_years) infoLine.push(`${Math.round(sp.lifespan_years)} yrs`);
        if (sp.threat_status) infoLine.push(`<span class="text-red-400">${sp.threat_status}</span>`);

        return `
            <tr class="hover:bg-white/5 transition-colors">
                <td class="px-4 py-3 text-sm text-gray-500 font-mono">${idx + 1}</td>
                <td class="px-4 py-3">
                    <div class="font-semibold text-white">${sp.canonical_name}</div>
                    ${infoLine.length > 0 ? `<div class="text-xs text-gray-500 mt-0.5">${infoLine.join(' ¬∑ ')}</div>` : ''}
                </td>
                <td class="px-4 py-3 text-sm text-gray-300">${sp.family}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 bg-amber-500/20 text-amber-400 rounded-full text-xs font-medium">
                        ${emoji} ${form}
                    </span>
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="${climateClass} font-semibold">${climatePercent}%</div>
                    <div class="w-full bg-white/10 rounded-full h-1 mt-1">
                        <div class="bg-gradient-to-r from-amber-500 to-emerald-500 h-full rounded-full" style="width: ${climatePercent}%"></div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center text-gray-400">${sp.n_ecoregions}</td>
                <td class="px-4 py-3 text-center text-gray-400">${sp.n_observations.toLocaleString()}</td>
            </tr>
        `;
    }).join('');

    // Scroll to results
    document.getElementById('eco-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Export functions
function exportSpeciesCSV() {
    if (!lastEcoData || !lastEcoData.species) {
        alert(currentLang === 'pt' ? 'Nenhum dado para exportar' : 'No data to export');
        return;
    }

    const headers = ['Rank', 'Species', 'Family', 'Growth Form', 'Climate Match (%)', 'Ecoregions', 'Observations', 'Max Height (m)', 'Lifespan (years)', 'Threat Status'];
    const rows = lastEcoData.species.map((sp, idx) => [
        idx + 1,
        sp.canonical_name,
        sp.family,
        sp.growth_form || 'tree',
        (sp.climate_match_score * 100).toFixed(1),
        sp.n_ecoregions,
        sp.n_observations,
        sp.max_height_m || '',
        sp.lifespan_years || '',
        sp.threat_status || ''
    ]);

    const csvContent = [headers.join(','), ...rows.map(row => row.map(cell => `"${cell}"`).join(','))].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `climate_adapted_species_${lastEcoData.ecoregion.eco_name.replace(/\s+/g, '_')}.csv`;
    link.click();
}

function copySpeciesToClipboard() {
    if (!lastEcoData || !lastEcoData.species) {
        alert(currentLang === 'pt' ? 'Nenhum dado para copiar' : 'No data to copy');
        return;
    }

    const text = lastEcoData.species.map((sp, idx) =>
        `${idx + 1}. ${sp.canonical_name} (${sp.family}) - ${(sp.climate_match_score * 100).toFixed(0)}% climate match`
    ).join('\n');

    navigator.clipboard.writeText(text).then(() => {
        alert(currentLang === 'pt' ? 'Copiado para √°rea de transfer√™ncia!' : 'Copied to clipboard!');
    });
}
</script>

        <!-- Custom Query -->
        <section class="animate-slide-up" style="animation-delay: 0.3s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
                Custom Query
            </h2>
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <div class="mb-6">
                    <label class="text-sm text-gray-400 font-medium mb-2 block">SQL Query (SELECT only)</label>
                    <textarea id="custom-query" rows="6" placeholder="SELECT * FROM species_unified LIMIT 10;"
                              class="query-input w-full px-5 py-4 bg-black/30 border border-white/10 rounded-xl text-emerald-300 placeholder-gray-600 focus:outline-none focus:border-purple-500/50 focus:ring-2 focus:ring-purple-500/20 transition-all duration-300 resize-none"></textarea>
                </div>
                <div class="flex items-center gap-4 mb-6">
                    <div class="flex-1">
                        <label class="text-sm text-gray-400 font-medium mb-2 block">Limit</label>
                        <input type="number" id="query-limit" value="100" min="1" max="1000"
                               class="w-full px-5 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-purple-500/50 transition-all duration-300">
                    </div>
                    <div class="flex items-end">
                        <button onclick="runCustomQuery()"
                                class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-semibold rounded-xl shadow-lg shadow-purple-500/20 hover:shadow-purple-500/40 transition-all duration-300 transform hover:scale-[1.02]">
                            Execute Query
                        </button>
                    </div>
                </div>

                <!-- Query presets -->
                <div class="mb-8">
                    <p class="text-sm text-gray-400 mb-3">Example queries:</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="setQuery('SELECT growth_form, COUNT(*) as total FROM species_unified WHERE growth_form IS NOT NULL GROUP BY growth_form ORDER BY total DESC')"
                                class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all duration-200">
                            Growth Forms
                        </button>
                        <button onclick="setQuery('SELECT s.family, COUNT(*) as total FROM species s JOIN species_unified su ON s.id = su.species_id WHERE su.is_tree = TRUE GROUP BY s.family ORDER BY total DESC LIMIT 20')"
                                class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all duration-200">
                            Top 20 Families (Trees)
                        </button>
                        <button onclick="setQuery('SELECT level3_code, level3_name, continent FROM tdwg_level3 WHERE level3_code LIKE \\'BZ%\\' ORDER BY level3_code')"
                                class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all duration-200">
                            Brazil Regions
                        </button>
                        <button onclick="setQuery('SELECT sr.tdwg_code, COUNT(*) as species_count FROM species_regions sr GROUP BY sr.tdwg_code ORDER BY species_count DESC LIMIT 20')"
                                class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all duration-200">
                            Top Regions
                        </button>
                        <button onclick="setQuery('EXPLAIN ANALYZE SELECT COUNT(*) FROM species_unified su JOIN species_regions sr ON su.species_id = sr.species_id WHERE sr.tdwg_code = \\'BZS\\' AND su.is_tree = TRUE')"
                                class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-sm text-gray-300 hover:text-white transition-all duration-200">
                            EXPLAIN Query
                        </button>
                    </div>
                    <p class="text-sm text-amber-400 mb-3">PostGIS / Geometry:</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="setQuery('SELECT level3_code, level3_name, ROUND((ST_Distance(geom, ST_SetSRID(ST_Point(-48.5480, -27.5954), 4326)) * 111)::numeric, 2) as dist_km FROM tdwg_level3 WHERE ST_DWithin(geom, ST_SetSRID(ST_Point(-48.5480, -27.5954), 4326), 0.5) ORDER BY dist_km LIMIT 1')"
                                class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 rounded-lg text-sm text-amber-300 hover:text-amber-200 transition-all duration-200">
                            TDWG by Coordinate (Floripa)
                        </button>
                        <button onclick="setQuery('SELECT s.canonical_name, s.family, su.growth_form FROM species s JOIN species_unified su ON s.id = su.species_id JOIN species_geometry sg ON s.id = sg.species_id WHERE su.is_tree = TRUE AND ST_DWithin(sg.native_range, ST_SetSRID(ST_Point(-48.5480, -27.5954), 4326), 0.1) LIMIT 20')"
                                class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 rounded-lg text-sm text-amber-300 hover:text-amber-200 transition-all duration-200">
                            Trees by Geometry (Floripa)
                        </button>
                        <button onclick="setQuery('SELECT s.canonical_name, s.family, sg.native_regions_count as regioes FROM species s JOIN species_unified su ON s.id = su.species_id JOIN species_geometry sg ON s.id = sg.species_id WHERE su.is_tree = TRUE ORDER BY sg.native_regions_count DESC LIMIT 20')"
                                class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 rounded-lg text-sm text-amber-300 hover:text-amber-200 transition-all duration-200">
                            Trees Largest Distribution
                        </button>
                        <button onclick="setQuery('SELECT s.canonical_name, sg.native_regions_count as regioes FROM species s JOIN species_unified su ON s.id = su.species_id JOIN species_geometry sg ON s.id = sg.species_id WHERE su.is_tree = TRUE ORDER BY sg.native_regions_count DESC LIMIT 20')"
                                class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 rounded-lg text-sm text-amber-300 hover:text-amber-200 transition-all duration-200">
                            Trees Most Regions
                        </button>
                        <button onclick="setQuery('SELECT COUNT(*) as arvores_floripa FROM species s JOIN species_unified su ON s.id = su.species_id JOIN species_geometry sg ON s.id = sg.species_id WHERE su.is_tree = TRUE AND ST_DWithin(sg.native_range, ST_SetSRID(ST_Point(-48.5480, -27.5954), 4326), 0.1)')"
                                class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 rounded-lg text-sm text-amber-300 hover:text-amber-200 transition-all duration-200">
                            Count Trees PostGIS
                        </button>
                        <button onclick="setQuery('EXPLAIN ANALYZE SELECT COUNT(*) FROM species_unified su JOIN species_geometry sg ON su.species_id = sg.species_id WHERE su.is_tree = TRUE AND ST_DWithin(sg.native_range, ST_SetSRID(ST_Point(-48.5480, -27.5954), 4326), 0.05)')"
                                class="px-4 py-2 bg-amber-500/10 hover:bg-amber-500/20 border border-amber-500/30 rounded-lg text-sm text-amber-300 hover:text-amber-200 transition-all duration-200">
                            EXPLAIN PostGIS
                        </button>
                    </div>
                </div>

                <!-- Query Results -->
                <div id="query-results" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <h3 class="text-lg font-semibold text-white">Result</h3>
                            <span id="result-count" class="px-3 py-1 bg-purple-500/20 text-purple-400 rounded-full text-sm font-medium">0 rows</span>
                        </div>
                        <span id="result-time" class="text-sm text-gray-400"></span>
                    </div>
                    <div id="query-error" class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 mb-4"></div>
                    <div class="overflow-x-auto rounded-xl border border-white/10">
                        <table class="w-full">
                            <thead id="result-thead" class="bg-white/5 border-b border-white/10">
                            </thead>
                            <tbody id="result-tbody" class="divide-y divide-white/5">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Data Quality Check -->
        <section class="animate-slide-up" style="animation-delay: 0.4s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Data Verification
            </h2>
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <button onclick="runDataCheck()"
                        class="mb-8 px-6 py-3 bg-gradient-to-r from-rose-600 to-orange-600 hover:from-rose-500 hover:to-orange-500 text-white font-semibold rounded-xl shadow-lg shadow-rose-500/20 hover:shadow-rose-500/40 transition-all duration-300 transform hover:scale-[1.02]">
                    Run Verification
                </button>
                <div id="data-checks" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Checks will be injected here -->
                </div>
            </div>
        </section>
    </main>

        <!-- Database Schema -->
        <section class="animate-slide-up" style="animation-delay: 0.5s">
            <h2 class="text-lg font-semibold text-gray-300 mb-6 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
                </svg>
                Table Structure
            </h2>
            <div class="card-gradient rounded-2xl border border-white/10 p-8 glow">
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">

                    <!-- species -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-emerald-500/20 to-cyan-500/20 border-b border-white/10">
                            <h3 class="font-bold text-emerald-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                species
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">Main species table</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">id</span><span class="text-gray-500">integer PK</span></div>
                            <div class="flex justify-between"><span class="text-white">canonical_name</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">genus</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">family</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">wcvp_id</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">gbif_taxon_key</span><span class="text-gray-500">bigint</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">gift_work_id</span><span class="text-gray-500">integer</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">reflora_id</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">wfo_id</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">taxonomic_status</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-purple-400">accepted_name_id</span><span class="text-gray-500">integer FK</span></div>
                        </div>
                    </div>

                    <!-- species_unified -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 border-b border-white/10">
                            <h3 class="font-bold text-cyan-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-cyan-500"></span>
                                species_unified
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">Consolidated traits (priority: gift > reflora > wcvp)</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">species_id</span><span class="text-gray-500">integer PK/FK</span></div>
                            <div class="flex justify-between"><span class="text-white">growth_form</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">growth_form_source</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">max_height_m</span><span class="text-gray-500">numeric</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">woodiness</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">nitrogen_fixer</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">dispersal_syndrome</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">is_tree</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">is_shrub</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">is_climber</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">is_herb</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">is_palm</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">is_native_brazil</span><span class="text-gray-500">boolean</span></div>
                        </div>
                    </div>

                    <!-- species_regions -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-purple-500/20 to-pink-500/20 border-b border-white/10">
                            <h3 class="font-bold text-purple-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                                species_regions
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">Geographic distribution by TDWG Level 3</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">id</span><span class="text-gray-500">integer PK</span></div>
                            <div class="flex justify-between"><span class="text-purple-400">species_id</span><span class="text-gray-500">integer FK</span></div>
                            <div class="flex justify-between"><span class="text-white">tdwg_code</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">is_native</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">is_endemic</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-rose-400">is_introduced</span><span class="text-gray-500">boolean</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">source</span><span class="text-gray-500">varchar</span></div>
                        </div>
                    </div>

                    <!-- species_geometry -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-amber-500/20 to-orange-500/20 border-b border-white/10">
                            <h3 class="font-bold text-amber-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                                species_geometry
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">PostGIS polygons (union of TDWG regions)</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">species_id</span><span class="text-gray-500">integer PK/FK</span></div>
                            <div class="flex justify-between"><span class="text-white">native_range</span><span class="text-gray-500">geometry</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">full_range</span><span class="text-gray-500">geometry</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">bbox</span><span class="text-gray-500">geometry</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">centroid</span><span class="text-gray-500">geometry</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">native_area_km2</span><span class="text-gray-500">numeric</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">native_regions_count</span><span class="text-gray-500">integer</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">full_regions_count</span><span class="text-gray-500">integer</span></div>
                        </div>
                    </div>

                    <!-- tdwg_level3 -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-rose-500/20 to-red-500/20 border-b border-white/10">
                            <h3 class="font-bold text-rose-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-rose-500"></span>
                                tdwg_level3
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">TDWG regions (369 global regions)</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">id</span><span class="text-gray-500">integer PK</span></div>
                            <div class="flex justify-between"><span class="text-white">level3_code</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-white">level3_name</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">level2_code</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">continent</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">geom</span><span class="text-gray-500">geometry</span></div>
                        </div>
                    </div>

                    <!-- common_names -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-teal-500/20 to-green-500/20 border-b border-white/10">
                            <h3 class="font-bold text-teal-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-teal-500"></span>
                                common_names
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">Common names (pt/en)</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">id</span><span class="text-gray-500">integer PK</span></div>
                            <div class="flex justify-between"><span class="text-purple-400">species_id</span><span class="text-gray-500">integer FK</span></div>
                            <div class="flex justify-between"><span class="text-white">common_name</span><span class="text-gray-500">text</span></div>
                            <div class="flex justify-between"><span class="text-white">language</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">source</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">verified</span><span class="text-gray-500">boolean</span></div>
                        </div>
                    </div>

                    <!-- tdwg_climate -->
                    <div class="bg-white/5 rounded-xl border border-white/10 overflow-hidden">
                        <div class="px-5 py-4 bg-gradient-to-r from-sky-500/20 to-cyan-500/20 border-b border-white/10">
                            <h3 class="font-bold text-sky-400 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-sky-500"></span>
                                tdwg_climate
                            </h3>
                            <p class="text-xs text-gray-400 mt-1">WorldClim bioclimatic by TDWG</p>
                        </div>
                        <div class="p-4 space-y-2 text-sm font-mono max-h-64 overflow-y-auto">
                            <div class="flex justify-between"><span class="text-blue-400">id</span><span class="text-gray-500">integer PK</span></div>
                            <div class="flex justify-between"><span class="text-purple-400">tdwg_code</span><span class="text-gray-500">varchar FK</span></div>
                            <div class="flex justify-between"><span class="text-rose-400">bio1_mean/min/max</span><span class="text-gray-500">decimal</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">bio2-bio11_mean</span><span class="text-gray-500">decimal</span></div>
                            <div class="flex justify-between"><span class="text-cyan-400">bio12_mean/min/max</span><span class="text-gray-500">decimal</span></div>
                            <div class="flex justify-between"><span class="text-gray-400">bio13-bio19_mean</span><span class="text-gray-500">decimal</span></div>
                            <div class="flex justify-between"><span class="text-emerald-400">whittaker_biome</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-amber-400">koppen_zone</span><span class="text-gray-500">varchar</span></div>
                            <div class="flex justify-between"><span class="text-purple-400">aridity_index</span><span class="text-gray-500">decimal</span></div>
                        </div>
                    </div>

                </div>

                <!-- Legend -->
                <div class="mt-8 pt-6 border-t border-white/10">
                    <p class="text-sm text-gray-400 mb-4">Color legend:</p>
                    <div class="flex flex-wrap gap-6 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded bg-blue-400"></span>
                            <span class="text-gray-300">Primary Key</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded bg-purple-400"></span>
                            <span class="text-gray-300">Foreign Key</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded bg-white"></span>
                            <span class="text-gray-300">NOT NULL</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded bg-emerald-400"></span>
                            <span class="text-gray-300">Filter fields</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded bg-amber-400"></span>
                            <span class="text-gray-300">External IDs / Geometry</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded bg-gray-400"></span>
                            <span class="text-gray-300">Nullable</span>
                        </div>
                    </div>
                </div>

                <!-- Relationships -->
                <div class="mt-8 pt-6 border-t border-white/10">
                    <p class="text-sm text-gray-400 mb-4">Relationships:</p>
                    <div class="bg-black/30 rounded-xl p-6 font-mono text-sm overflow-x-auto">
                        <pre class="text-gray-300">
species (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1) species_unified     [consolidated traits]
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) species_regions     [N TDWG regions per species]
                 ‚îÇ              ‚îÇ
                 ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ tdwg_level3  [FK: tdwg_code ‚Üí level3_code]
                 ‚îÇ
                 ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (1) species_geometry    [polygon = union of regions]
                 ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ (N) common_names        [names in pt/en]</pre>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/10 mt-20">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex items-center justify-between text-gray-500 text-sm">
                <p>DiversiPlant Admin - Database Explorer</p>
                <p>PostGIS + PostgreSQL 16</p>
            </div>
        </div>
    </footer>

    <script>
        const API_BASE = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadStats();
            loadSources();
            setInterval(checkHealth, 30000);
        });

        // Health Check
        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/api/health`);
                const data = await res.json();

                const dot = document.getElementById('health-dot');
                const text = document.getElementById('health-text');

                if (data.status === 'ok' && data.database === 'connected') {
                    dot.className = 'w-2.5 h-2.5 rounded-full bg-emerald-500 animate-pulse-slow';
                    text.textContent = `Online - PostGIS ${data.postgis.split(' ')[0]}`;
                    text.className = 'text-sm text-emerald-400';
                } else {
                    dot.className = 'w-2.5 h-2.5 rounded-full bg-red-500';
                    text.textContent = 'Connection error';
                    text.className = 'text-sm text-red-400';
                }
            } catch (e) {
                document.getElementById('health-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-500';
                document.getElementById('health-text').textContent = 'Connection error';
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();

                const stats = [
                    { label: 'Species', value: data.total_species, color: 'from-emerald-500 to-teal-500' },
                    { label: 'Unified', value: data.species_unified, color: 'from-cyan-500 to-blue-500' },
                    { label: 'Regions', value: data.species_regions, color: 'from-purple-500 to-pink-500' },
                    { label: 'Geometries', value: data.species_geometry, color: 'from-amber-500 to-orange-500' },
                    { label: 'TDWG', value: data.tdwg_regions, color: 'from-rose-500 to-red-500' },
                ];

                document.getElementById('stats-grid').innerHTML = stats.map(s => `
                    <div class="card-gradient rounded-2xl border border-white/10 p-6 hover:border-white/20 transition-all duration-300 hover:transform hover:scale-105">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br ${s.color} opacity-80"></div>
                            <span class="text-gray-400 text-sm font-medium">${s.label}</span>
                        </div>
                        <p class="text-3xl font-bold text-white">${formatNumber(s.value)}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // Load Sources
        async function loadSources() {
            try {
                const res = await fetch(`${API_BASE}/api/sources`);
                const data = await res.json();

                const colors = {
                    'gift': 'emerald',
                    'wcvp': 'cyan',
                    'reflora': 'amber',
                    'treegoer': 'purple',
                    'practitioners': 'rose',
                    'try': 'violet'
                };

                // Growth Form Sources
                if (data.growth_form && data.growth_form.length > 0) {
                    document.getElementById('sources-grid').innerHTML = data.growth_form.map(s => {
                        const color = colors[s.source] || 'gray';
                        return `
                            <div class="p-5 bg-white/5 rounded-xl border border-white/10 hover:border-${color}-500/30 transition-all duration-300">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-md font-semibold text-${color}-400 uppercase">${s.source}</span>
                                    <span class="text-xl font-bold text-white">${formatNumber(s.total)}</span>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between text-gray-400">
                                        <span>Trees</span>
                                        <span class="text-white">${formatNumber(s.trees)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>Shrubs</span>
                                        <span class="text-white">${formatNumber(s.shrubs)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>Herbs</span>
                                        <span class="text-white">${formatNumber(s.herbs)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>Climbers</span>
                                        <span class="text-white">${formatNumber(s.climbers)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Threat Status Sources
                if (data.threat_status && data.threat_status.length > 0) {
                    document.getElementById('threat-sources-grid').innerHTML = data.threat_status.map(s => {
                        const color = colors[s.source] || 'gray';
                        const threatened = s.cr + s.en + s.vu;
                        return `
                            <div class="p-5 bg-white/5 rounded-xl border border-white/10 hover:border-rose-500/30 transition-all duration-300">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-md font-semibold text-${color}-400 uppercase">${s.source}</span>
                                    <span class="text-xl font-bold text-white">${formatNumber(s.total)}</span>
                                </div>
                                <div class="mb-3 p-2 bg-rose-500/10 rounded-lg">
                                    <div class="text-xs text-gray-400 mb-1">Threatened (CR+EN+VU)</div>
                                    <div class="text-lg font-bold text-rose-400">${formatNumber(threatened)}</div>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between text-gray-400">
                                        <span class="text-red-400">CR (Critical)</span>
                                        <span class="text-white">${formatNumber(s.cr)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span class="text-orange-400">EN (Endangered)</span>
                                        <span class="text-white">${formatNumber(s.en)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span class="text-amber-400">VU (Vulnerable)</span>
                                        <span class="text-white">${formatNumber(s.vu)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>NT (Near Threatened)</span>
                                        <span class="text-white">${formatNumber(s.nt)}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>LC (Least Concern)</span>
                                        <span class="text-white">${formatNumber(s.lc)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('threat-sources-grid').innerHTML = '<p class="text-gray-500">No threat_status data found</p>';
                }

                // Lifespan Sources
                if (data.lifespan && data.lifespan.length > 0) {
                    document.getElementById('lifespan-sources-grid').innerHTML = data.lifespan.map(s => {
                        const color = colors[s.source] || 'gray';
                        return `
                            <div class="p-5 bg-white/5 rounded-xl border border-white/10 hover:border-purple-500/30 transition-all duration-300">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-md font-semibold text-${color}-400 uppercase">${s.source}</span>
                                    <span class="text-xl font-bold text-white">${formatNumber(s.total)}</span>
                                </div>
                                <div class="space-y-1 text-sm">
                                    <div class="flex justify-between text-gray-400">
                                        <span>Average</span>
                                        <span class="text-purple-400 font-semibold">${s.avg_lifespan ? s.avg_lifespan + ' years' : '-'}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>Minimum</span>
                                        <span class="text-white">${s.min_lifespan ? s.min_lifespan + ' years' : '-'}</span>
                                    </div>
                                    <div class="flex justify-between text-gray-400">
                                        <span>Maximum</span>
                                        <span class="text-white">${s.max_lifespan ? s.max_lifespan + ' years' : '-'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('lifespan-sources-grid').innerHTML = '<p class="text-gray-500">No lifespan data found</p>';
                }
            } catch (e) {
                console.error('Failed to load sources:', e);
            }
        }

        // Query by Location
        async function queryByLocation(method) {
            const lat = document.getElementById('lat-input').value;
            const lon = document.getElementById('lon-input').value;
            const growthForm = document.getElementById('growth-form-select').value;
            const limit = document.getElementById('limit-input').value;
            const nativeOnly = document.getElementById('native-only').checked;

            document.getElementById('results-container').classList.remove('hidden');

            if (method === 'tdwg') {
                await queryByTDWG(lat, lon, growthForm, limit, nativeOnly);
            } else if (method === 'postgis') {
                await queryByPostGIS(lat, lon, growthForm, limit);
            }
        }

        // Query by TDWG Region
        async function queryByTDWG(lat, lon, growthForm, limit, nativeOnly) {
            try {
                const tdwgRes = await fetch(`${API_BASE}/api/tdwg?lat=${lat}&lon=${lon}`);
                if (!tdwgRes.ok) {
                    alert('TDWG region not found for these coordinates');
                    return;
                }
                const tdwg = await tdwgRes.json();

                document.getElementById('tdwg-results').classList.remove('hidden');
                document.getElementById('tdwg-name').textContent = tdwg.name;
                document.getElementById('tdwg-code').textContent = tdwg.code + (tdwg.distance_km ? ` (${tdwg.distance_km}km)` : '');

                let url = `${API_BASE}/api/species?tdwg_code=${tdwg.code}&limit=${limit}`;
                if (growthForm) url += `&growth_form=${growthForm}`;
                if (nativeOnly) url += `&native_only=true`;

                const speciesRes = await fetch(url);
                const data = await speciesRes.json();

                document.getElementById('tdwg-count').textContent = formatNumber(data.total);
                document.getElementById('tdwg-time').textContent = data.query_time;

                document.getElementById('tdwg-tbody').innerHTML = data.species.map(sp => `
                    <tr class="table-row transition-all duration-200">
                        <td class="px-4 py-3">
                            <span class="text-white text-sm italic">${sp.canonical_name}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-400 text-sm">${sp.family || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 bg-white/10 rounded text-xs text-gray-300">${sp.growth_form || '-'}</span>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('TDWG Query failed:', e);
                alert('TDWG query error: ' + e.message);
            }
        }

        // Query by PostGIS Geometry
        async function queryByPostGIS(lat, lon, growthForm, limit) {
            try {
                document.getElementById('postgis-results').classList.remove('hidden');
                document.getElementById('postgis-coords').textContent = `${lat}, ${lon}`;
                document.getElementById('postgis-tbody').innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-400">Loading...</td></tr>';
                document.getElementById('postgis-count').textContent = '...';

                let growthFilter = '';
                if (growthForm === 'tree') growthFilter = 'AND su.is_tree = TRUE';
                else if (growthForm === 'shrub') growthFilter = 'AND su.is_shrub = TRUE';
                else if (growthForm === 'herb') growthFilter = 'AND su.is_herb = TRUE';
                else if (growthForm === 'climber') growthFilter = 'AND su.is_climber = TRUE';
                else if (growthForm === 'palm') growthFilter = 'AND su.is_palm = TRUE';

                // First get total count (without LIMIT)
                const countSql = `SELECT COUNT(*) as total
                    FROM species s
                    JOIN species_unified su ON s.id = su.species_id
                    JOIN species_geometry sg ON s.id = sg.species_id
                    WHERE ST_DWithin(sg.native_range, ST_SetSRID(ST_Point(${lon}, ${lat}), 4326), 0.1)
                    ${growthFilter}`;

                const countRes = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql: countSql, limit: 1 })
                });
                const countData = await countRes.json();
                const totalCount = countData.rows?.[0]?.[0] || 0;

                // Then get species with LIMIT
                const sql = `SELECT s.canonical_name, s.family, su.growth_form
                    FROM species s
                    JOIN species_unified su ON s.id = su.species_id
                    JOIN species_geometry sg ON s.id = sg.species_id
                    WHERE ST_DWithin(sg.native_range, ST_SetSRID(ST_Point(${lon}, ${lat}), 4326), 0.1)
                    ${growthFilter}
                    ORDER BY s.canonical_name
                    LIMIT ${limit}`;

                const res = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql, limit: parseInt(limit) })
                });
                const data = await res.json();

                if (data.error) {
                    document.getElementById('postgis-tbody').innerHTML = `<tr><td colspan="3" class="px-4 py-8 text-center text-red-400">${data.error}</td></tr>`;
                    return;
                }

                document.getElementById('postgis-count').textContent = formatNumber(totalCount);
                document.getElementById('postgis-time').textContent = data.query_time;

                document.getElementById('postgis-tbody').innerHTML = data.rows.map(row => `
                    <tr class="table-row transition-all duration-200">
                        <td class="px-4 py-3">
                            <span class="text-white text-sm italic">${row[0]}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-400 text-sm">${row[1] || '-'}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 bg-white/10 rounded text-xs text-gray-300">${row[2] || '-'}</span>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('PostGIS Query failed:', e);
                alert('PostGIS query error: ' + e.message);
            }
        }

        // Set Query
        function setQuery(sql) {
            document.getElementById('custom-query').value = sql;
        }

        // Run Custom Query
        async function runCustomQuery() {
            const sql = document.getElementById('custom-query').value;
            const limit = document.getElementById('query-limit').value;

            try {
                const res = await fetch(`${API_BASE}/api/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql, limit: parseInt(limit) })
                });
                const data = await res.json();

                document.getElementById('query-results').classList.remove('hidden');

                if (data.error) {
                    document.getElementById('query-error').classList.remove('hidden');
                    document.getElementById('query-error').textContent = data.error;
                    document.getElementById('result-thead').innerHTML = '';
                    document.getElementById('result-tbody').innerHTML = '';
                    return;
                }

                document.getElementById('query-error').classList.add('hidden');
                document.getElementById('result-count').textContent = `${data.row_count} rows`;
                document.getElementById('result-time').textContent = `Query: ${data.query_time}`;

                document.getElementById('result-thead').innerHTML = `
                    <tr>
                        ${data.columns.map(col => `<th class="px-6 py-4 text-left text-sm font-semibold text-gray-300">${col}</th>`).join('')}
                    </tr>
                `;

                document.getElementById('result-tbody').innerHTML = data.rows.map(row => `
                    <tr class="table-row transition-all duration-200">
                        ${row.map(cell => `<td class="px-6 py-4 text-gray-300">${cell !== null ? cell : '<span class="text-gray-600">NULL</span>'}</td>`).join('')}
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Query failed:', e);
                alert('Query execution error: ' + e.message);
            }
        }

        // Data Quality Check
        async function runDataCheck() {
            const checks = [
                { name: 'Species with growth_form', query: 'SELECT COUNT(*) FROM species_unified WHERE growth_form IS NOT NULL', threshold: 300000, reverse: true, description: 'Species with growth form' },
                { name: 'Species with region', query: 'SELECT COUNT(DISTINCT species_id) FROM species_regions', threshold: 300000, reverse: true, description: 'Species with geographic distribution' },
                { name: 'Species with geometry', query: 'SELECT COUNT(*) FROM species_geometry WHERE native_range IS NOT NULL', threshold: 300000, reverse: true, description: 'Species with PostGIS polygon' },
                { name: 'TDWG Regions', query: 'SELECT COUNT(*) FROM tdwg_level3 WHERE geom IS NOT NULL', threshold: 360, reverse: true, description: 'TDWG regions with polygon' },
                { name: 'Unified total', query: 'SELECT COUNT(*) FROM species_unified', threshold: 300000, reverse: true, description: 'Total unified records' },
                { name: 'Common names PT', query: 'SELECT COUNT(*) FROM common_names WHERE language = \'pt\'', threshold: 1000, reverse: true, description: 'Common names in Portuguese' },
            ];

            const container = document.getElementById('data-checks');
            container.innerHTML = '<p class="text-gray-400 col-span-2">Running verifications...</p>';

            const results = [];
            for (const check of checks) {
                try {
                    const res = await fetch(`${API_BASE}/api/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sql: check.query, limit: 1 })
                    });
                    const data = await res.json();

                    if (!data.error && data.rows.length > 0) {
                        const value = parseInt(data.rows[0][0]);
                        const ok = check.reverse ? value >= check.threshold : value <= check.threshold;
                        results.push({ ...check, value, ok });
                    } else {
                        results.push({ ...check, value: 'Erro', ok: false });
                    }
                } catch (e) {
                    results.push({ ...check, value: 'Erro', ok: false });
                }
            }

            container.innerHTML = results.map(r => `
                <div class="p-6 rounded-xl border ${r.ok ? 'bg-emerald-500/5 border-emerald-500/20' : 'bg-red-500/5 border-red-500/20'} transition-all duration-300">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold ${r.ok ? 'text-emerald-400' : 'text-red-400'}">${r.name}</span>
                        <span class="text-2xl font-bold ${r.ok ? 'text-emerald-400' : 'text-red-400'}">
                            ${typeof r.value === 'number' ? formatNumber(r.value) : r.value}
                        </span>
                    </div>
                    <p class="text-sm text-gray-400">${r.description}</p>
                    <div class="mt-3 flex items-center gap-2">
                        ${r.ok
                            ? '<svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span class="text-sm text-emerald-400">OK</span>'
                            : '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg><span class="text-sm text-red-400">Warning</span>'
                        }
                    </div>
                </div>
            `).join('');
        }

        // Format number
        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return new Intl.NumberFormat('en-US').format(num);
        }

        // Climate Functions
        function setClimateTDWG(code) {
            document.getElementById('climate-tdwg-input').value = code;
            document.getElementById('climate-lat-input').value = '';
            document.getElementById('climate-lon-input').value = '';
            queryClimate();
        }

        async function queryClimatePoint() {
            const lat = document.getElementById('climate-lat-input').value;
            const lon = document.getElementById('climate-lon-input').value;

            if (!lat || !lon) {
                alert('For precise raster query, provide latitude and longitude');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/climate/point?lat=${lat}&lon=${lon}`);
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Error fetching raster data');
                    return;
                }
                const data = await res.json();
                displayClimatePointData(data);
            } catch (e) {
                console.error('Climate point query failed:', e);
                alert('Error fetching raster data: ' + e.message);
            }
        }

        function displayClimatePointData(data) {
            document.getElementById('climate-result').classList.remove('hidden');

            // Region info (for point query, use coordinates)
            document.getElementById('climate-region-name').textContent = `${data.lat?.toFixed(4)}, ${data.lon?.toFixed(4)}`;
            document.getElementById('climate-region-code').textContent = `Raster Preciso (${data.source || 'worldclim_raster'})`;

            // Biome & K√∂ppen
            document.getElementById('climate-biome').textContent = data.whittaker_biome || '-';
            document.getElementById('climate-koppen').textContent = data.koppen_zone || '-';
            document.getElementById('climate-aridity').textContent = data.aridity_index ? parseFloat(data.aridity_index).toFixed(1) : '-';

            // Temperature (bio1)
            const bio1 = data.bio1 || data.bio1_mean;
            document.getElementById('climate-temp-mean').textContent = bio1 ? `${parseFloat(bio1).toFixed(1)}¬∞C` : '-';
            document.getElementById('climate-temp-min').textContent = '-';
            document.getElementById('climate-temp-max').textContent = '-';

            // Precipitation (bio12)
            const bio12 = data.bio12 || data.bio12_mean;
            document.getElementById('climate-precip-mean').textContent = bio12 ? `${formatNumber(Math.round(parseFloat(bio12)))} mm` : '-';
            document.getElementById('climate-precip-min').textContent = '-';
            document.getElementById('climate-precip-max').textContent = '-';

            // All BIO variables
            const bioVars = [
                { key: 'bio1', label: 'BIO1', desc: 'Mean Annual Temp', unit: '¬∞C' },
                { key: 'bio2', label: 'BIO2', desc: 'Diurnal Range', unit: '¬∞C' },
                { key: 'bio3', label: 'BIO3', desc: 'Isothermality', unit: '%' },
                { key: 'bio4', label: 'BIO4', desc: 'Temp Seasonality', unit: '' },
                { key: 'bio5', label: 'BIO5', desc: 'Max Warmest Month', unit: '¬∞C' },
                { key: 'bio6', label: 'BIO6', desc: 'Min Coldest Month', unit: '¬∞C' },
                { key: 'bio7', label: 'BIO7', desc: 'Annual Range', unit: '¬∞C' },
                { key: 'bio8', label: 'BIO8', desc: 'Temp Wettest Qtr', unit: '¬∞C' },
                { key: 'bio9', label: 'BIO9', desc: 'Temp Driest Qtr', unit: '¬∞C' },
                { key: 'bio10', label: 'BIO10', desc: 'Temp Warmest Qtr', unit: '¬∞C' },
                { key: 'bio11', label: 'BIO11', desc: 'Temp Coldest Qtr', unit: '¬∞C' },
                { key: 'bio12', label: 'BIO12', desc: 'Annual Precip', unit: 'mm' },
                { key: 'bio13', label: 'BIO13', desc: 'Precip Wettest Month', unit: 'mm' },
                { key: 'bio14', label: 'BIO14', desc: 'Precip Driest Month', unit: 'mm' },
                { key: 'bio15', label: 'BIO15', desc: 'Precip Seasonality', unit: 'CV' },
                { key: 'bio16', label: 'BIO16', desc: 'Precip Wettest Qtr', unit: 'mm' },
                { key: 'bio17', label: 'BIO17', desc: 'Precip Driest Qtr', unit: 'mm' },
                { key: 'bio18', label: 'BIO18', desc: 'Precip Warmest Qtr', unit: 'mm' },
                { key: 'bio19', label: 'BIO19', desc: 'Precip Coldest Qtr', unit: 'mm' },
            ];

            document.getElementById('climate-all-bio').innerHTML = bioVars.map(v => {
                const value = data[v.key];
                const formatted = value !== null && value !== undefined
                    ? (v.unit === 'mm' ? formatNumber(Math.round(parseFloat(value))) : parseFloat(value).toFixed(1))
                    : '-';
                return `
                    <div class="p-3 bg-violet-500/10 rounded-lg border border-violet-500/20">
                        <p class="text-xs text-violet-400 font-semibold">${v.label}</p>
                        <p class="text-white font-bold">${formatted}${v.unit ? ' ' + v.unit : ''}</p>
                        <p class="text-xs text-gray-500">${v.desc}</p>
                    </div>
                `;
            }).join('');
        }

        async function queryClimate() {
            const tdwgCode = document.getElementById('climate-tdwg-input').value.trim();
            const lat = document.getElementById('climate-lat-input').value;
            const lon = document.getElementById('climate-lon-input').value;

            let url = `${API_BASE}/api/climate`;
            if (tdwgCode) {
                url += `?tdwg_code=${tdwgCode}`;
            } else if (lat && lon) {
                url += `?lat=${lat}&lon=${lon}`;
            } else {
                alert('Provide a TDWG code or coordinates');
                return;
            }

            try {
                const res = await fetch(url);
                if (!res.ok) {
                    const err = await res.json();
                    alert(err.error || 'Error fetching climate data');
                    return;
                }
                const data = await res.json();
                displayClimateData(data);
            } catch (e) {
                console.error('Climate query failed:', e);
                alert('Error fetching climate data: ' + e.message);
            }
        }

        function displayClimateData(data) {
            document.getElementById('climate-result').classList.remove('hidden');

            // Region info
            document.getElementById('climate-region-name').textContent = data.tdwg_name || data.tdwg_code;
            document.getElementById('climate-region-code').textContent = data.tdwg_code;

            // Biome & K√∂ppen
            document.getElementById('climate-biome').textContent = data.whittaker_biome || '-';
            document.getElementById('climate-koppen').textContent = data.koppen_zone || '-';
            document.getElementById('climate-aridity').textContent = data.aridity_index ? data.aridity_index.toFixed(1) : '-';

            // Temperature
            document.getElementById('climate-temp-mean').textContent = data.bio1_mean ? `${data.bio1_mean.toFixed(1)}¬∞C` : '-';
            document.getElementById('climate-temp-min').textContent = data.bio1_min ? `${data.bio1_min.toFixed(1)}¬∞C` : '-';
            document.getElementById('climate-temp-max').textContent = data.bio1_max ? `${data.bio1_max.toFixed(1)}¬∞C` : '-';

            // Precipitation
            document.getElementById('climate-precip-mean').textContent = data.bio12_mean ? `${formatNumber(Math.round(data.bio12_mean))} mm` : '-';
            document.getElementById('climate-precip-min').textContent = data.bio12_min ? `${formatNumber(Math.round(data.bio12_min))} mm` : '-';
            document.getElementById('climate-precip-max').textContent = data.bio12_max ? `${formatNumber(Math.round(data.bio12_max))} mm` : '-';

            // All BIO variables
            const bioVars = [
                { key: 'bio1_mean', label: 'BIO1', desc: 'Mean Annual Temp', unit: '¬∞C' },
                { key: 'bio2_mean', label: 'BIO2', desc: 'Diurnal Range', unit: '¬∞C' },
                { key: 'bio3_mean', label: 'BIO3', desc: 'Isothermality', unit: '%' },
                { key: 'bio4_mean', label: 'BIO4', desc: 'Temp Seasonality', unit: '' },
                { key: 'bio5_mean', label: 'BIO5', desc: 'Max Warmest Month', unit: '¬∞C' },
                { key: 'bio6_mean', label: 'BIO6', desc: 'Min Coldest Month', unit: '¬∞C' },
                { key: 'bio7_mean', label: 'BIO7', desc: 'Annual Range', unit: '¬∞C' },
                { key: 'bio8_mean', label: 'BIO8', desc: 'Temp Wettest Qtr', unit: '¬∞C' },
                { key: 'bio9_mean', label: 'BIO9', desc: 'Temp Driest Qtr', unit: '¬∞C' },
                { key: 'bio10_mean', label: 'BIO10', desc: 'Temp Warmest Qtr', unit: '¬∞C' },
                { key: 'bio11_mean', label: 'BIO11', desc: 'Temp Coldest Qtr', unit: '¬∞C' },
                { key: 'bio12_mean', label: 'BIO12', desc: 'Annual Precip', unit: 'mm' },
                { key: 'bio13_mean', label: 'BIO13', desc: 'Precip Wettest Month', unit: 'mm' },
                { key: 'bio14_mean', label: 'BIO14', desc: 'Precip Driest Month', unit: 'mm' },
                { key: 'bio15_mean', label: 'BIO15', desc: 'Precip Seasonality', unit: 'CV' },
                { key: 'bio16_mean', label: 'BIO16', desc: 'Precip Wettest Qtr', unit: 'mm' },
                { key: 'bio17_mean', label: 'BIO17', desc: 'Precip Driest Qtr', unit: 'mm' },
                { key: 'bio18_mean', label: 'BIO18', desc: 'Precip Warmest Qtr', unit: 'mm' },
                { key: 'bio19_mean', label: 'BIO19', desc: 'Precip Coldest Qtr', unit: 'mm' },
            ];

            document.getElementById('climate-all-bio').innerHTML = bioVars.map(v => {
                const value = data[v.key];
                const formatted = value !== null && value !== undefined
                    ? (v.unit === 'mm' ? formatNumber(Math.round(value)) : value.toFixed(1))
                    : '-';
                return `
                    <div class="p-3 bg-white/5 rounded-lg">
                        <p class="text-xs text-sky-400 font-semibold">${v.label}</p>
                        <p class="text-white font-bold">${formatted}${v.unit ? ' ' + v.unit : ''}</p>
                        <p class="text-xs text-gray-500">${v.desc}</p>
                    </div>
                `;
            }).join('');
        }

        async function loadClimateStats() {
            try {
                const res = await fetch(`${API_BASE}/api/climate/stats`);
                const data = await res.json();

                // Biome distribution
                if (data.biome_breakdown && data.biome_breakdown.length > 0) {
                    const maxBiome = Math.max(...data.biome_breakdown.map(b => b.count));
                    document.getElementById('biome-distribution').innerHTML = data.biome_breakdown.map(b => `
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-300">${b.biome || 'No data'}</span>
                                    <span class="text-emerald-400 font-semibold">${b.count} <span class="text-gray-500 text-xs">(${b.avg_temp?.toFixed(1) || '-'}¬∞C)</span></span>
                                </div>
                                <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 rounded-full" style="width: ${(b.count / maxBiome * 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // K√∂ppen distribution
                if (data.koppen_breakdown && data.koppen_breakdown.length > 0) {
                    const maxKoppen = Math.max(...data.koppen_breakdown.map(k => k.count));
                    document.getElementById('koppen-distribution').innerHTML = data.koppen_breakdown.map(k => `
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-300">${k.zone || 'No data'}</span>
                                    <span class="text-amber-400 font-semibold">${k.count}</span>
                                </div>
                                <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full" style="width: ${(k.count / maxKoppen * 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Failed to load climate stats:', e);
            }
        }
    </script>
</body>
</html>
